<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:viewmodels="clr-namespace:Audiobookplayer.ViewModels"
             xmlns:models="clr-namespace:Audiobookplayer.Models"
             xmlns:toolkit="http://schemas.microsoft.com/dotnet/2022/maui/toolkit"
             xmlns:freakyEffects="clr-namespace:Maui.FreakyEffects.TouchEffects;assembly=Maui.FreakyEffects"
             x:Class="Audiobookplayer.Pages.LibraryPage"
             Title="Library">
    <ContentPage.BindingContext>
        <viewmodels:LibraryViewModel/>
    </ContentPage.BindingContext>
    <ContentPage.ToolbarItems>
        <ToolbarItem
            Text="Edit"
            IconImageSource="edit.png"
            Command="{Binding ToggleEditModeCommand}"/>
    </ContentPage.ToolbarItems>
    <ContentView BackgroundColor="Black">
        <Grid>
            <CollectionView x:DataType="viewmodels:LibraryViewModel" 
                        BackgroundColor="White"
                        Margin="0, 1, 0, 0"
                        ItemsSource="{Binding Audiobooks}"
                        ItemsLayout="VerticalList">
                <CollectionView.EmptyView>
                    <StackLayout VerticalOptions="Center" HorizontalOptions="Center">
                        <Label Text="No audiobooks available" 
                           FontSize="20" 
                           FontAttributes="Bold" 
                           HorizontalOptions="Center" />
                        <Label Text="Please add audiobooks to your library" 
                           FontSize="16" 
                           HorizontalOptions="Center" />
                    </StackLayout>
                </CollectionView.EmptyView>

                <CollectionView.ItemTemplate>
                    <DataTemplate  x:DataType="models:Audiobook">
                        <Grid>
                            <Grid
                            Padding="10"
                            ColumnSpacing="5"
                            Grid.RowSpan="3"
                            InputTransparent="False"
                            BackgroundColor="White"
                            freakyEffects:TouchEffect.Color="AliceBlue"
                            freakyEffects:Commands.Tap="{Binding BindingContext.SelectAudiobookCommand, Source={RelativeSource AncestorType={x:Type ContentPage}}}"
                            freakyEffects:Commands.TapParameter="{Binding .}">
                                <Grid.Triggers>
                                    <DataTrigger
                                    TargetType="Grid"
                                    Binding="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:LibraryViewModel}}, Path=InEditMode}"
                                    Value="True">
                                        <Setter 
                                        Property="InputTransparent"
                                        Value="True"/>
                                    </DataTrigger>
                                </Grid.Triggers>
                                <Grid.RowDefinitions>
                                    <RowDefinition Height="Auto" />
                                    <RowDefinition Height="Auto" />
                                    <RowDefinition Height="Auto" />
                                </Grid.RowDefinitions>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="Auto" />
                                    <ColumnDefinition Width="*" />
                                </Grid.ColumnDefinitions>
                                <Grid.Behaviors>
                                    <toolkit:TouchBehavior
                                
                                    
                                    />
                                </Grid.Behaviors>
                                <Border Grid.RowSpan="3"
                                StrokeShape="RoundRectangle 10, 10, 10, 10">
                                    <Image Source="{Binding CoverImage}"
                               Aspect="AspectFill"
                               HeightRequest="90"
                               WidthRequest="90"/>
                                </Border>
                                <Label Text="{Binding Title}"
                               Grid.Column="1"
                               Grid.Row="0"
                               FontSize="17"
                               FontAttributes="Bold"
                               LineBreakMode="WordWrap"
                               VerticalOptions="Center"/>
                                <Label Text="{Binding Author}"
                               Grid.Row="1"
                               Grid.Column="1"
                               FontSize="16"
                               FontAttributes="Italic"
                               VerticalOptions="Center"/>
                                <Label Text="{Binding Narrator}"
                               Grid.Row="2"
                               Grid.Column="1"
                               FontSize="16"
                               FontAttributes="Italic"
                               VerticalOptions="Center"/>
                            </Grid>

                            <HorizontalStackLayout
                            Spacing="-10"
                            Grid.Column="1"
                            Grid.Row="1"
                            VerticalOptions="Center"
                            HorizontalOptions="End">
                                <ImageButton
                                Command="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:LibraryViewModel}}, Path=EditAudiobookCommand}"
                                CommandParameter="{Binding .}"
                                Source="edit.png"
                                WidthRequest="20"
                                HeightRequest="20"
                                Scale="0.65"
                                HorizontalOptions="End"
                                VerticalOptions="Center"
                                IsVisible="False">
                                    <ImageButton.Triggers>
                                        <DataTrigger
                                    TargetType="ImageButton"
                                    Binding="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:LibraryViewModel}}, Path=InEditMode}"
                                    Value="True">
                                            <Setter 
                                        Property="IsVisible"
                                        Value="True"/>
                                        </DataTrigger>
                                    </ImageButton.Triggers>
                                </ImageButton>
                                <ImageButton
                                Command="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:LibraryViewModel}}, Path=DeleteAudiobookCommand}"
                                CommandParameter="{Binding .}"
                                Source="redtrash.png"
                                WidthRequest="20"
                                HeightRequest="20"
                                HorizontalOptions="End"
                                VerticalOptions="Center"
                                IsVisible="False">
                                    <ImageButton.Triggers>
                                        <DataTrigger
                                    TargetType="ImageButton"
                                    Binding="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:LibraryViewModel}}, Path=InEditMode}"
                                    Value="True">
                                            <Setter 
                                        Property="IsVisible"
                                        Value="True"/>
                                        </DataTrigger>
                                    </ImageButton.Triggers>
                                </ImageButton>
                            </HorizontalStackLayout>
                        </Grid>
                    </DataTemplate>
                </CollectionView.ItemTemplate>
            </CollectionView>
        </Grid>
    </ContentView>
</ContentPage>